
PRAGMA foreign_keys = OFF;      -- disables use of foreign key constraints

-- Safely removes any (or all) the relations that is pre-loaded in the schema
DROP TABLE IF EXISTS PersonalClient;
DROP TABLE IF EXISTS PersonalPhone;
DROP TABLE IF EXISTS NominatedDrivers;
DROP TABLE IF EXISTS CompanyClient;
DROP TABLE IF EXISTS CompanyPhone;
DROP TABLE IF EXISTS Booking;
DROP TABLE IF EXISTS Depot;
DROP TABLE IF EXISTS DepotPhone;
DROP TABLE IF EXISTS Vehicle;
DROP TABLE IF EXISTS VehicleType;
DROP TABLE IF EXISTS DailyTariff;
DROP TABLE IF EXISTS VehicleTariff;
DROP TABLE IF EXISTS Insurance;
DROP TABLE IF EXISTS VehicleInsurance;
DROP TABLE IF EXISTS Invoice;
DROP TABLE IF EXISTS hiredVehicle;


PRAGMA foreign_keys = ON;       -- enables use of foreign key constraints (to enfore referential integrity)

--PersonalClient
CREATE TABLE PersonalClient(
    --AUTOINCREMENT has been used to auto generate a unique clientID when entry is created (also allows for a custom value to be used)
    clientID INTEGER PRIMARY KEY AUTOINCREMENT,
    fname VARCHAR(20) NOT NULL,
    lname VARCHAR(20) NOT NULL,
    title VARCHAR(4),
    clientLicense CHAR(12) NOT NULL,    --This is the client's license number (they don't have to be the nominated driver)
    street VARCHAR(45) NOT NULL,    --VARCHAR has been used as street can have a varied length, but must be at max 45 characters long
    postcode CHAR(4) NOT NULL   --CHAR has been used as we know the postcode MUST be 4 characters long

);




--PersonalPhone
CREATE TABLE PersonalPhone(
    clientID INT NOT NULL,
    phoneNo CHAR(14) NOT NULL,
    PRIMARY KEY(clientID, phoneNo),     --Composite Primary Key of PersonalPhone
    FOREIGN KEY (clientID) REFERENCES PersonalClient(clientID)
        ON UPDATE CASCADE   --Used to ensure values auto update values if any changes in PersonalClient are made
        ON DELETE CASCADE   --Used to ensure values auto delete if client in parent table is deleted

);

CREATE TRIGGER max_two_personal_phone_numbers
    BEFORE INSERT ON PersonalPhone
    FOR EACH ROW
    WHEN (SELECT COUNT(*) FROM PersonalPhone WHERE clientID = NEW.clientID) >= 2
BEGIN
    SELECT RAISE(ABORT, 'Cannot insert more than 2 phone numbers for a client!');
END;

--NominatedDrivers
CREATE TABLE NominatedDrivers(
    clientID INT NOT NULL,
    driversNum CHAR(12) NOT NULL,
    PRIMARY KEY(clientID, driversNum),    --Composite Primary Key of NominatedDrivers
    FOREIGN KEY (clientID) REFERENCES PersonalClient(clientID)
        ON UPDATE CASCADE   --Used to ensure values auto update values if any changes in PersonalClient are made
        ON DELETE CASCADE   --Used to ensure values auto delete if client in parent table is deleted
);

CREATE TRIGGER max_three_drivers_per_car
    BEFORE INSERT ON NominatedDrivers
    FOR EACH ROW
    WHEN (SELECT COUNT(*) FROM NominatedDrivers WHERE clientID = NEW.clientID) >= 3
BEGIN
    SELECT RAISE(ABORT, 'Cannot have more than 3 designated drivers!');
END;


--CompanyClient
CREATE TABLE CompanyClient(
    --AUTOINCREMENT has been used to auto generate a unique CompanyID when entry is created (also allows for a custom value to be used)
    CompanyID INTEGER PRIMARY KEY AUTOINCREMENT,
    street VARCHAR(45) NOT NULL,
    postcode CHAR(4) NOT NULL,
    cName VARCHAR(50) NOT NULL,     --Company's name
    clientID INT NOT NULL,      --Link's Company to their appropriate representative, who's details is recorded as a PersonalClient
    FOREIGN KEY (clientID) REFERENCES PersonalClient(clientID)
        ON UPDATE CASCADE   --Used to ensure values auto update values if any changes in PersonalClient are made
        ON DELETE CASCADE   --Used to ensure values auto delete if client in parent table is deleted

);

--CompanyPhone
CREATE TABLE CompanyPhone(
    CompanyID INT NOT NULL,
    phoneNo CHAR(12) NOT NULL,
    PRIMARY KEY(CompanyID, phoneNo),
    FOREIGN KEY (CompanyID) REFERENCES CompanyClient(CompanyID)
        ON UPDATE CASCADE    --Used to ensure values auto update values if any changes in CompanyClient are made
        ON DELETE CASCADE   --Used to ensure values auto delete if Company in parent table is deleted
);

CREATE TRIGGER max_two_company_phone_numbers
    BEFORE INSERT ON CompanyPhone
    FOR EACH ROW
    WHEN (SELECT COUNT(*) FROM CompanyPhone WHERE CompanyID = NEW.CompanyID) >= 2
BEGIN
    SELECT RAISE(ABORT, 'Cannot insert more than 2 phone numbers for a company!');
END;


--Booking
CREATE TABLE Booking (
    startdate DATE,     --In the form 'YYYY-MM-DD'
    hireDays INT NOT NULL,
    colour VARCHAR(12) DEFAULT NULL,    --Colour is suggest as optional; if no specific choice is registered, it is set as NULL
    clientID INT NOT NULL,
    depotID INT NOT NULL,
    make VARCHAR(8) NOT NULL,
    model VARCHAR(20) NOT NULL,
    PRIMARY KEY(startdate, clientID),   --Composite Primary key of Booking
    FOREIGN KEY (clientID) REFERENCES PersonalClient(clientID)  --Links Client to their Booking
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (depotID) REFERENCES Depot(depotID) --Links Booking to the designated Depot
        ON UPDATE CASCADE
        ON DELETE NO ACTION,    -- NO ACTION is used to ensure if Depot is deleted, no deletion occurs in Booking as a result
    FOREIGN KEY (make, model) REFERENCES VehicleType(make, model) -- Links the Make and Model of Vehicle being booked to Booking
        ON UPDATE CASCADE
        ON DELETE NO ACTION
);

--Depot
CREATE TABLE Depot (
    depotID INT PRIMARY KEY,
    street VARCHAR(45) NOT NULL,
    postcode CHAR(4) NOT NULL,
    email VARCHAR(24) NOT NULL
);

--DepotPhone
CREATE TABLE DepotPhone(
    depotID INT NOT NULL,
    phoneNo CHAR(14) NOT NULL,
    PRIMARY KEY(depotID, phoneNo),  --Composite Primary key of DepotPhone
    FOREIGN KEY (depotID) REFERENCES Depot(depotID)     --Links the phone numbers to designated Depot
        ON UPDATE CASCADE
        ON DELETE CASCADE
);

CREATE TRIGGER max_four_depot_phone_numbers
    BEFORE INSERT ON DepotPhone
    FOR EACH ROW
    WHEN (SELECT COUNT(*) FROM DepotPhone WHERE depotID = NEW.depotID) >= 4
BEGIN
    SELECT RAISE(ABORT, 'Cannot insert more than 4 phone numbers for a depot!');
END;

--Vehicle
CREATE TABLE Vehicle(
    regNum CHAR(7) PRIMARY KEY,
    FleetNum INT NOT NULL,
    colour VARCHAR(20) NOT NULL,
    depotID INT,
    make VARCHAR(8) NOT NULL,
    model VARCHAR(20) NOT NULL,
    FOREIGN KEY (depotID) REFERENCES Depot(depotID) -- Vehicle may be designated to a depot location, but doesn't have to
        ON UPDATE CASCADE
        ON DELETE SET NULL,
    FOREIGN KEY (make, model) REFERENCES VehicleType(make, model)   --A vehicle must have a make and model
        ON UPDATE CASCADE
        ON DELETE NO ACTION
);


--VehicleType
CREATE TABLE VehicleType(
    make VARCHAR(8) NOT NULL,
    model VARCHAR(20) NOT NULL,
    doors INT NOT NULL,
    body VARCHAR(10) NOT NULL,
    trim VARCHAR(10) NOT NULL,
    fuel VARCHAR(10) NOT NULL,
    PRIMARY KEY(make, model)    --Composite primary key of VehicleType
);

--DailyTariff
CREATE TABLE DailyTariff(
    tariffID CHAR(2) PRIMARY KEY,   --Uniquely identifies tarrif
    conditions VARCHAR(50) NOT NULL

);

--VehicleTariff
CREATE TABLE VehicleTariff(     --Junction table created for DailyTariff and VehicleType
    tariffID CHAR(2) NOT NULL,
    make VARCHAR(8) NOT NULL,
    model VARCHAR(8) NOT NULL,
    rentalPrice DECIMAL (5, 2) NOT NULL,
    PRIMARY KEY(tariffID, make, model),     --Composite comprised of the Primary keys from DailyTariff and VehicleType
    FOREIGN KEY (tariffID) REFERENCES DailyTariff(tariffID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    FOREIGN KEY (make, model) REFERENCES VehicleType(make, model)
        ON UPDATE CASCADE
        ON DELETE NO ACTION
);

--Insurance
CREATE TABLE Insurance(
    insuranceID INT PRIMARY KEY,
    policyType VARCHAR(20) NOT NULL,
    cost DECIMAL (5, 2) NOT NULL
);

--VehicleInsurance
CREATE TABLE VehicleInsurance(      --Junction table between Insurance and hiredVehicle
    insuranceID INT NOT NULL,
    hireDate DATE NOT NULL,
    clientID INT NOT NULL,
    regNum CHAR(7) NOT NULL,
    policyNo VARCHAR(10) NOT NULL,
    PRIMARY KEY(policyNo), -- Composite primary key comprised of the primary keys in Insurance and hiredVehicle
    FOREIGN KEY (insuranceID) REFERENCES Insurance(insuranceID)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    FOREIGN KEY (clientID, hireDate) REFERENCES hiredVehicle(clientID, hireDate)
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (regNum) REFERENCES Vehicle(regNum)
        ON UPDATE CASCADE
        ON DELETE NO ACTION
);

--Invoice
CREATE TABLE Invoice(    
    invoiceID INT PRIMARY KEY,
    qualityCheck CHAR(1) NOT NULL,
    datepaid DATE NOT NULL,
    finalcost DECIMAL (5, 2) NOT NULL,      -- Final derived cost of rental based on (no. of hire days x daily rental tariff)
    hireDate DATE NOT NULL,
    clientID INT NOT NULL,
    FOREIGN KEY (clientID, hireDate) REFERENCES hiredVehicle(clientID, hireDate)
        ON UPDATE CASCADE
        ON DELETE CASCADE
);

--hiredVehicle
CREATE TABLE hiredVehicle(
    hireDate DATE NOT NULL,     --In the form 'YYYY-MM-DD'
    cardType CHAR(2) NOT NULL,
    cardNo CHAR(20) NOT NULL,
    odometer INT NOT NULL,
    hireDays INT NOT NULL,
    tariffID CHAR(2) NOT NULL,
    pickupDepot INT NOT NULL,
    returnDepot INT NOT NULL,
    clientID INT NOT NULL,
    regNum CHAR(7) NOT NULL,
    insuranceID INT,
    PRIMARY KEY(hireDate, clientID),
    FOREIGN KEY (tariffID) REFERENCES DailyTariff(tariffID) --TariffID of vehicle hired is linked to hire details
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    FOREIGN KEY (pickupDepot) REFERENCES Depot(depotID) --Vehicle must be picked up at a depot (but doesn't have to be returned there)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    FOREIGN KEY (returnDepot) REFERENCES Depot(depotID) --Vehicle must be returned at a depot (but doesn't have to be picked up there)
        ON UPDATE CASCADE
        ON DELETE NO ACTION,
    FOREIGN KEY (clientID) REFERENCES PersonalClient(clientID)  --Hire must reference a client 
        ON UPDATE CASCADE
        ON DELETE CASCADE,
    FOREIGN KEY (regNum) REFERENCES Vehicle(regNum)
        ON UPDATE CASCADE
        ON DELETE NO ACTION ,
    FOREIGN KEY (insuranceID) REFERENCES Insurance(insuranceID) --Insurance is an optional choice when hiring a vehicle
        ON UPDATE CASCADE
        ON DELETE SET NULL      -- If not insurance is taken or is deleted it is set as NULL
);

